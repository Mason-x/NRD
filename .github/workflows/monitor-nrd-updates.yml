# ç›‘æ§NRDæ–‡ä»¶æ›´æ–°çš„GitHub Actionså·¥ä½œæµ 
name: Monitor NRD File Updates

on:
  schedule:
    # æ¯3å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼ˆGitHub Actionsæœ€å°é—´éš”ï¼‰
   - cron: '0 */3 * * *'  # æ¯3å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰

jobs:
  monitor-and-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        pip install requests
    
    - name: Monitor and download file updates
      id: monitor
      run: |
        python << 'EOF'
        import requests
        import hashlib
        import os
        import json
        from datetime import datetime
        
        def log(message):
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] {message}")
        
        # é…ç½®
        source_url = "https://raw.githubusercontent.com/xRuffKez/NRD/main/lists/30-day-mini/domains-only/nrd-30day-mini.txt"
        state_file = "monitor_state.json"
        downloads_dir = "downloads"
        archive_dir = "archive"
        
        # åˆ›å»ºç›®å½•
        os.makedirs(downloads_dir, exist_ok=True)
        os.makedirs(archive_dir, exist_ok=True)
        
        log("å¼€å§‹æ£€æŸ¥NRDæ–‡ä»¶æ›´æ–°...")
        
        # åŠ è½½ä¸Šæ¬¡çŠ¶æ€
        last_state = {}
        if os.path.exists(state_file):
            try:
                with open(state_file, 'r') as f:
                    last_state = json.load(f)
                log(f"åŠ è½½ä¸Šæ¬¡çŠ¶æ€: {last_state.get('last_update', 'é¦–æ¬¡è¿è¡Œ')}")
            except Exception as e:
                log(f"åŠ è½½çŠ¶æ€æ–‡ä»¶å¤±è´¥: {e}")
        
        try:
            # ä¸‹è½½æºæ–‡ä»¶
            log(f"æ­£åœ¨ä¸‹è½½: {source_url}")
            response = requests.get(source_url, timeout=30)
            response.raise_for_status()
            content = response.text.strip()
            
            if not content:
                log("é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶å†…å®¹ä¸ºç©º")
                exit(1)
            
            # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
            current_hash = hashlib.sha256(content.encode('utf-8')).hexdigest()
            last_hash = last_state.get('hash', '')
            
            log(f"å½“å‰æ–‡ä»¶å“ˆå¸Œ: {current_hash[:16]}...")
            log(f"ä¸Šæ¬¡æ–‡ä»¶å“ˆå¸Œ: {last_hash[:16] if last_hash else 'æ— '}...")
            
            # ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
            lines = content.split('\n')
            domain_count = len([line for line in lines if line.strip() and not line.startswith('#')])
            
            log(f"æ–‡ä»¶åŒ…å« {domain_count} ä¸ªåŸŸå")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
            if current_hash != last_hash:
                log("ğŸ‰ æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ–°!")
                
                # ç”Ÿæˆæ—¶é—´æˆ³å’Œæ–‡ä»¶å
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                filename = f"nrd-30day-mini_{timestamp}.txt"
                
                # ä¿å­˜åˆ°downloadsç›®å½•ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
                latest_file = os.path.join(downloads_dir, "nrd-30day-mini-latest.txt")
                with open(latest_file, 'w', encoding='utf-8') as f:
                    f.write(content)
                log(f"âœ… æœ€æ–°ç‰ˆæœ¬å·²ä¿å­˜: {latest_file}")
                
                # ä¿å­˜åˆ°archiveç›®å½•ï¼ˆå†å²ç‰ˆæœ¬ï¼‰
                archive_file = os.path.join(archive_dir, filename)
                with open(archive_file, 'w', encoding='utf-8') as f:
                    f.write(content)
                log(f"ğŸ“ å†å²ç‰ˆæœ¬å·²ä¿å­˜: {archive_file}")
                
                # åˆ›å»ºæ›´æ–°æ‘˜è¦
                summary = {
                    "update_time": datetime.now().isoformat(),
                    "timestamp": timestamp,
                    "filename": filename,
                    "hash": current_hash,
                    "domain_count": domain_count,
                    "file_size": len(content),
                    "source_url": source_url
                }
                
                # æ›´æ–°çŠ¶æ€æ–‡ä»¶
                new_state = {
                    "hash": current_hash,
                    "last_update": datetime.now().isoformat(),
                    "filename": filename,
                    "domain_count": domain_count,
                    "update_history": last_state.get('update_history', [])
                }
                
                # ä¿ç•™æœ€è¿‘10æ¬¡æ›´æ–°å†å²
                new_state['update_history'].append(summary)
                if len(new_state['update_history']) > 10:
                    new_state['update_history'] = new_state['update_history'][-10:]
                
                with open(state_file, 'w') as f:
                    json.dump(new_state, f, indent=2)
                
                # åˆ›å»ºæ›´æ–°æŠ¥å‘Š
                report_file = os.path.join(downloads_dir, "latest_update_report.md")
                with open(report_file, 'w') as f:
                    f.write(f"# NRDæ–‡ä»¶æ›´æ–°æŠ¥å‘Š\n\n")
                    f.write(f"- **æ›´æ–°æ—¶é—´**: {summary['update_time']}\n")
                    f.write(f"- **æ–‡ä»¶å“ˆå¸Œ**: `{current_hash[:16]}...`\n")
                    f.write(f"- **åŸŸåæ•°é‡**: {domain_count}\n")
                    f.write(f"- **æ–‡ä»¶å¤§å°**: {len(content):,} å­—èŠ‚\n")
                    f.write(f"- **æºæ–‡ä»¶**: [é“¾æ¥]({source_url})\n\n")
                    f.write(f"## æœ€æ–°æ–‡ä»¶\n\n")
                    f.write(f"- [ä¸‹è½½æœ€æ–°ç‰ˆæœ¬](./nrd-30day-mini-latest.txt)\n")
                    f.write(f"- [æŸ¥çœ‹å†å²ç‰ˆæœ¬](../archive/)\n\n")
                    f.write(f"*æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*\n")
                
                # è®¾ç½®GitHub Actionsè¾“å‡º
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f"updated=true\n")
                    f.write(f"filename={filename}\n")
                    f.write(f"hash={current_hash[:16]}\n")
                    f.write(f"domain_count={domain_count}\n")
                    f.write(f"timestamp={timestamp}\n")
                
                log(f"âœ… æ‰€æœ‰æ–‡ä»¶å·²æ›´æ–°å®Œæˆ")
                
            else:
                log("â„¹ï¸  æ–‡ä»¶æ— æ›´æ–°")
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f"updated=false\n")
                    f.write(f"domain_count={domain_count}\n")
        
        except Exception as e:
            log(f"âŒ é”™è¯¯: {e}")
            exit(1)
        
        log("ç›‘æ§ä»»åŠ¡å®Œæˆ")
        EOF
    
    - name: Commit and push changes
      if: steps.monitor.outputs.updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add .
        git commit -m "ğŸ¤– Auto-update: NRD file ${{ steps.monitor.outputs.filename }} (domains: ${{ steps.monitor.outputs.domain_count }})" || exit 0
        git push
    
    - name: Create summary
      run: |
        echo "## ğŸ“Š ç›‘æ§æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **æ£€æŸ¥æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.monitor.outputs.updated }}" == "true" ]; then
          echo "- **çŠ¶æ€**: âœ… æ£€æµ‹åˆ°æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–°æ–‡ä»¶**: ${{ steps.monitor.outputs.filename }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸåæ•°é‡**: ${{ steps.monitor.outputs.domain_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å“ˆå¸Œ**: ${{ steps.monitor.outputs.hash }}..." >> $GITHUB_STEP_SUMMARY
        else
          echo "- **çŠ¶æ€**: â„¹ï¸ æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸŸåæ•°é‡**: ${{ steps.monitor.outputs.domain_count }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **æºä»“åº“**: [xRuffKez/NRD](https://github.com/xRuffKez/NRD)" >> $GITHUB_STEP_SUMMARY
